<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>PathGuardian - Caretaker Dashboard</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="js/shared-data.js"></script>
    <script src="js/alert-system.js"></script>
    <script src="js/demo-manager.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { "primary": "#3670e2", "danger": "#ef4444", "warning": "#f59e0b", "success": "#10b981" },
                    fontFamily: { "display": ["Lexend", "sans-serif"] },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Lexend', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        #map {
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0;
        }

        .clip-avatar {
            clip-path: circle(50% at 50% 50%);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900 h-screen flex flex-col overflow-hidden relative">

    <!-- HEADER / ALERT BANNER -->
    <div class="absolute top-4 left-4 right-4 z-20 flex gap-2" id="top-bar">
        <!-- Dynamic Alert Banner will appear here -->
    </div>

    <!-- MAP -->
    <div id="map"></div>

    <!-- RECENTER BUTTON -->
    <button onclick="fitAll()"
        class="absolute bottom-60 right-4 z-20 w-12 h-12 bg-white rounded-xl shadow-lg flex items-center justify-center text-slate-600 active:scale-95 transition-transform">
        <span class="material-icons-round">crop_free</span>
    </button>

    <!-- BOTTOM CAROUSEL (Person Cards) -->
    <div class="absolute bottom-24 left-0 right-0 z-20 px-4 pb-2 flex gap-4 overflow-x-auto snap-x no-scrollbar"
        id="person-carousel" style="scroll-padding-left: 1rem; scroll-padding-right: 1rem;">
        <!-- Filled by JS -->
    </div>

    <!-- BOTTOM NAVIGATION -->
    <nav
        class="absolute bottom-0 left-0 right-0 z-30 glass-panel border-t border-slate-200 pb-6 pt-3 px-6 flex justify-between items-center shadow-[0_-10px_40px_rgba(0,0,0,0.05)]">
        <a href="caretaker_dashboard.html" class="flex flex-col items-center gap-1 text-primary">
            <span class="material-icons-round text-2xl">map</span>
            <span class="text-[10px] font-bold">Map</span>
        </a>
        <a href="caretaker_alerts.html" class="flex flex-col items-center gap-1 text-slate-400 relative">
            <span class="material-icons-round text-2xl">notifications</span>
            <span class="text-[10px] font-medium">Alerts</span>
            <span id="nav-alert-badge"
                class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white hidden"></span>
        </a>
        <a href="add_people.html"
            class="w-14 h-14 bg-primary text-white rounded-full flex items-center justify-center -mt-8 border-4 border-slate-50 shadow-xl active:scale-95 transition-transform">
            <span class="material-icons-round text-3xl">add</span>
        </a>
        <a href="caretaker_history.html" class="flex flex-col items-center gap-1 text-slate-400">
            <span class="material-icons-round text-2xl">history</span>
            <span class="text-[10px] font-medium">History</span>
        </a>
        <a href="caretaker_settings.html" class="flex flex-col items-center gap-1 text-slate-400">
            <span class="material-icons-round text-2xl">settings</span>
            <span class="text-[10px] font-medium">Settings</span>
        </a>
    </nav>

    <script>
        // Init Map
        const map = L.map('map', { zoomControl: false }).setView([1.2950, 103.8500], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

        const markers = {};
        const people = window.SharedData.getPeople();

        function renderMapMarkers() {
            people.forEach(p => {
                const color = p.status === 'danger' ? '#ef4444' : (p.status === 'warning' ? '#f59e0b' : '#3670e2');
                const pulseClass = p.status === 'danger' ? 'animate-ping' : '';

                const icon = L.divIcon({
                    html: `<div style="position:relative">
                            <div style="width:40px;height:40px;background:${color};padding:2px;border-radius:50%;box-shadow:0 4px 10px rgba(0,0,0,0.2)">
                                <img src="${p.photoUrl}" class="w-full h-full rounded-full object-cover border-2 border-white">
                            </div>
                            <div style="position:absolute;bottom:-5px;left:50%;transform:translateX(-50%);background:white;padding:1px 6px;border-radius:8px;font-size:10px;font-weight:bold;white-space:nowrap;box-shadow:0 2px 4px rgba(0,0,0,0.1)">${p.name.split(' ')[0]}</div>
                           </div>`,
                    iconSize: [40, 48], iconAnchor: [20, 40], className: ''
                });

                if (markers[p.id]) {
                    markers[p.id].setLatLng([p.location.lat, p.location.lng]);
                    markers[p.id].setIcon(icon);
                } else {
                    markers[p.id] = L.marker([p.location.lat, p.location.lng], { icon: icon }).addTo(map);
                    markers[p.id].on('click', () => {
                        map.flyTo([p.location.lat, p.location.lng], 17);
                        document.getElementById('card-' + p.id).scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
                    });
                }
            });
        }

        function renderCards() {
            const container = document.getElementById('person-carousel');
            container.innerHTML = '';

            people.forEach(p => {
                const statusColor = p.status === 'danger' ? 'text-red-500' : (p.status === 'warning' ? 'text-amber-500' : 'text-green-500');
                const statusText = p.status === 'danger' ? 'Alert!' : (p.status === 'warning' ? 'Warning' : 'Safe');
                const bg = p.id === 'p1' ? 'border-primary border-2' : 'border border-slate-100'; // Highlight first one for demo

                const card = document.createElement('div');
                card.className = `min-w-[85%] bg-white rounded-2xl p-4 shadow-xl snap-center ${bg}`;
                card.id = 'card-' + p.id;
                card.onclick = () => { map.flyTo([p.location.lat, p.location.lng], 17); };

                card.innerHTML = `
                    <div class="flex items-center gap-4 mb-3">
                        <img src="${p.photoUrl}" class="w-12 h-12 rounded-full object-cover border-2 border-slate-100">
                        <div class="flex-1">
                            <h3 class="font-bold text-lg leading-tight text-slate-800">${p.name}</h3>
                            <p class="text-xs text-slate-500 font-medium">${p.relationship} â€¢ Battery ${p.battery}%</p>
                        </div>
                        <div class="flex flex-col items-end">
                            <span class="font-bold uppercase text-xs ${statusColor} flex items-center gap-1">
                                <span class="material-icons-round text-sm">circle</span> ${statusText}
                            </span>
                            <span class="text-[10px] text-slate-400 font-bold mt-1">${window.SharedData.timeAgo(p.lastActive)}</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <div class="flex-1 bg-slate-50 rounded-xl px-3 py-2 flex items-center gap-2">
                            <span class="material-icons-round text-slate-400 text-lg">place</span>
                            <span class="text-xs font-bold text-slate-700 truncate">${p.location.name}</span>
                        </div>
                        <button class="w-10 h-10 bg-primary/10 rounded-xl flex items-center justify-center text-primary active:scale-95 transition-transform" onclick="event.stopPropagation(); window.location.href='caretaker_alerts.html'">
                            <span class="material-icons-round text-lg">visibility</span>
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });

            // Spacer
            const spacer = document.createElement('div');
            spacer.className = "min-w-[4px]";
            container.appendChild(spacer);
        }

        function checkAlerts() {
            const count = window.AlertSystem.getActiveAlertCount();
            const badge = document.getElementById('nav-alert-badge');
            if (count > 0) {
                badge.classList.remove('hidden');

                // Show Banner if not already shown
                const alerts = window.AlertSystem.getAlerts().filter(a => a.status === 'active');
                if (alerts.length > 0) {
                    const topBar = document.getElementById('top-bar');
                    topBar.innerHTML = `
                        <div onclick="window.location.href='caretaker_alerts.html'" class="flex-1 bg-red-500 text-white p-3 rounded-xl shadow-lg flex items-center gap-3 animate-pulse cursor-pointer">
                            <span class="material-icons-round">warning</span>
                            <div class="flex-1">
                                <span class="font-bold block text-sm">Alert: ${alerts[0].title}</span>
                                <span class="text-xs opacity-90">${alerts[0].locationName}</span>
                            </div>
                            <span class="material-icons-round">chevron_right</span>
                        </div>
                    `;
                }
            } else {
                badge.classList.add('hidden');
                document.getElementById('top-bar').innerHTML = '';
            }
        }

        function fitAll() {
            const group = new L.featureGroup(Object.values(markers));
            map.fitBounds(group.getBounds().pad(0.2));
        }

        renderMapMarkers();
        renderCards();
        fitAll();
        checkAlerts();

        // live updates
        window.addEventListener('alerts-updated', checkAlerts);
        setInterval(() => {
            renderMapMarkers(); // In real app, fetch new positions here
        }, 5000);

    </script>
</body>

</html>